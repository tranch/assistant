version: '3'

tasks:
  default:
    cmds:
      - go env
      - git version
      - docker version

  build:
    desc: Build the go binary.
    cmds:
      - GOVERSION=`go version` goreleaser --snapshot --skip-publish --rm-dist

  wire:
    desc: Code generated by Wire
    cmds:
      - wire ./...

  lint:
    desc: Run golangci-lint check
    cmds:
      - golangci-lint run ./... --timeout=5m

  proto:
    desc: Generate proto.pb.go
    cmds:
      - go run scripts/rm/main.go
      - protoc -I api/pb ./api/pb/* --gogo_out=plugins=grpc:.
      - protoc-go-inject-tag -input=./api/pb/middle.pb.go
      - git add api/pb/*.pb.go

  release:
    desc: Push github release
    cmds:
      - goreleaser release --snapshot --rm-dist

  docker:
    desc: Docker-compose run
    cmds:
      - docker-compose -f deployments/docker-compose/docker-compose.yml up --build -d

  changelog:
    desc: Generate changelog
    cmds:
      - git-chglog -o CHANGELOG.md
