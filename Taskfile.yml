version: '3'

tasks:
  default:
    cmds:
      - go env
      - git version
      - docker version

  build:
    desc: Build the go binary.
    cmds:
      - GOVERSION=`go version` goreleaser --snapshot --skip-publish --rm-dist

  wire:
    desc: Code generated by Wire
    cmds:
      - wire ./cmd/...
      - wire ./internal/...

  lint:
    desc: Run golangci-lint check
    cmds:
      - golangci-lint run ./... --timeout=5m

  proto:
    desc: Generate proto.pb.go
    cmds:
      - go run scripts/rm/main.go
      - protoc -I api/pb ./api/pb/* --gogo_out=plugins=grpc:.
      - protoc-go-inject-tag -input=./api/pb/middle.pb.go
      - git add api/pb/*.pb.go

  release:
    desc: Push github release
    cmds:
      - goreleaser release --snapshot --rm-dist

  docker:
    desc: Docker-compose run
    cmds:
      - docker-compose -f deployments/docker-compose/docker-compose.yml up --build -d

  changelog:
    desc: Generate changelog
    cmds:
      - git-chglog -o CHANGELOG.md

  mock:
    desc: Generate mock files
    cmds:
      - mockgen -source=./api/pb/message.pb.go -destination=./mock/message_client.go -package=mock
      - mockgen -source=./api/pb/middle.pb.go -destination=./mock/middle_client.go -package=mock
      - mockgen -source=./api/pb/nlp.pb.go -destination=./mock/nlp_client.go -package=mock
      - mockgen -source=./api/pb/subscribe.pb.go -destination=./mock/subscribe_client.go -package=mock
      - mockgen -source=./api/pb/todo.pb.go -destination=./mock/todo_client.go -package=mock
      - mockgen -source=./api/pb/user.pb.go -destination=./mock/user_client.go -package=mock
      - mockgen -source=./api/pb/workflow.pb.go -destination=./mock/workflow_client.go -package=mock
      - mockgen -source=./internal/app/todo/repository/todo.go -destination=./mock/todo_repository.go -package=mock
      - mockgen -source=./internal/app/message/repository/message.go -destination=./mock/message_repository.go -package=mock
      - mockgen -source=./internal/app/middle/repository/middle.go -destination=./mock/middle_repository.go -package=mock
      - mockgen -source=./internal/app/user/repository/user.go -destination=./mock/user_repository.go -package=mock
      - mockgen -source=./internal/app/workflow/repository/workflow.go -destination=./mock/workflow_repository.go -package=mock
